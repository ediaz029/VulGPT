## Backend Tasks Overview

This backend workspace contains the Python utilities that power the vulnerability benchmarking pipeline:

- `filter_minimal_sets.py` enriches OSV data and produces the curated package list.
- `checkout_repos.py` clones the repositories and writes a checkout manifest.
- `run_vulnerability_scanner.py` traverses the checked-out worktrees, chunks code, and calls a local Ollama model to surface vulnerability leads.

The sections below focus on running the scanner so you can reproduce our dry-run and full-scan flows.

## Prerequisites

- Python dependencies are managed with [uv](https://github.com/astral-sh/uv). Install them once from this directory:

	```bash
	uv sync
	```

- Ollama must be installed locally with the target model pulled (e.g., `ollama pull mistral`) and the daemon running on `http://localhost:11434`.
- The checkout manifest generated by `checkout_repos.py` must be available (e.g., `data/checkout_manifest_sample.json` in the repo root).

## Dry run: validate wiring without LLM usage

From the repository root, execute the scanner with `--dry-run` to confirm manifest loading, traversal, and chunking:

```bash
PYTHONPATH=src uv run --project src/backend/api python src/backend/tasks/run_vulnerability_scanner.py \
	--manifest data/checkout_manifest_sample.json \
	--output data/scanner_dry_run.json \
	--model mistral \
	--include-ext .py .js \
	--dry-run \
	--log-level INFO
```

The resulting JSON captures the resolved options plus chunk metadata (no LLM calls are issued when `dry_run` is true).

## Full scan: collect vulnerability leads

Remove `--dry-run` to let the scanner submit each chunk to Ollama and gather YAML findings:

```bash
PYTHONPATH=src uv run --project src/backend/api python src/backend/tasks/run_vulnerability_scanner.py \
	--manifest data/checkout_manifest_sample.json \
	--output data/scanner_findings.json \
	--model mistral \
	--include-ext .py .js \
	--log-level INFO
```

Additional flags you may find useful:

- `--max-files`, `--max-chunks`: limit work per package to control runtime.
- `--exclude-dirs`: extend the default ignore list.
- `--concurrency`: balance throughput vs. Ollama load (default `2`).
- `--max-packages`: cap the number of manifest entries processed.

## Output interpretation

- Dry runs produce an empty `results` array and a `stats` object describing chunk counts.
- Full runs populate `results` with one entry per discovered lead, including the originating file, chunk index, model response, and timestamps. These JSON artifacts feed downstream scoring or manual triage.

## Troubleshooting

- **Missing dependencies**: run `uv sync` again to ensure `httpx` and `PyYAML` are installed.
- **Ollama connection errors**: verify the daemon is running (`ollama serve`) and that the selected model is pulled locally.
- **Large repositories**: adjust `--chunk-size` or tighten `--max-files` to keep requests within the modelâ€™s context window.
